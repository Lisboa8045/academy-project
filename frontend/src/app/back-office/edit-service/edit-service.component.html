@if(loading()) {
  <app-loading/>
  } @else {
  <div class="card">
    <span class="header">
      <h2>Manage Service</h2>
      <div>
        <button *ngIf="!form.enabled && userCanEdit()" type="button" (click)="form.enable()" class="edit-button">Edit Service</button>
        <button *ngIf="service!.permissions.includes(ProviderPermissionEnumModel.DELETE) && !form.enabled" class="cancel-button" (click)="deleteServiceModal.set(true)">Delete Service</button>
      </div>
    </span>
    <form [formGroup]="form"
          (keydown.enter)="$event.preventDefault()"
          (ngSubmit)="submit()">
      <fieldset>
        <legend>Service Info</legend>
        <div class="input-wrapper">
          <label>Name:</label>
          <input type="text" placeholder="Enter Service Name" formControlName="name"/>
          <div class="validation-error" *ngIf="form.get('name')?.invalid && form.get('name')?.touched">
            Name is required and should be less than 60 characters.
          </div>
        </div>

        <div class="input-wrapper">
          <label>Description:</label>
          <textarea formControlName="description"></textarea>
          <div class="validation-error" *ngIf="form.get('description')?.invalid && form.get('description')?.touched">
            Description is required and should be less than 2000 characters.
          </div>
        </div>
        <div class="input-wrapper">
          <label for="serviceTypeName">Service Type:</label>
          <select id="serviceTypeName" formControlName="serviceTypeName">
            <option value="" disabled selected>Select a service type</option>
            <option *ngFor="let option of serviceTypeOptions" [value]="option.name">
              {{ option.name }}
            </option>
          </select>
          <div class="validation-error"
               *ngIf="form.get('serviceTypeName')?.invalid && form.get('serviceTypeName')?.touched">
            Required field.
          </div>
        </div>

        <div class="input-wrapper">
          <label>Duration (minutes):</label>
          <input type="number" formControlName="duration"/>
          <div class="validation-error"
               *ngIf="form.get('duration')?.invalid && form.get('duration')?.touched">
            Duration should be greater than 0.
          </div>
        </div>
      </fieldset>
      <fieldset>
        <legend>Images and tags</legend>
        <div class="image-tags-section">
          <div class="image-hover-container">
            <div class="image-wrapper">
              <button class="nav left" (click)="prevImage(thumbContainer)" type="button" [disabled]="currentImageIndex === 0">&#10094;
              </button>
              @if (imageUrls.length === 0) {
                <div class="thumbnail-placeholder">
                  No Image Provided
                </div>
              } @else {
                <img
                  [src]="imageUrls[currentImageIndex]"
                  alt="Service Image"
                  class="main-image"
                />
              }
              <button class="nav right" (click)="nextImage(thumbContainer)" type="button"
                      [disabled]="currentImageIndex === imageUrls.length - 1">&#10095;
              </button>

              <div class="thumbnails-overlay">
                <div class="thumbnails-scroll-wrapper" #thumbContainer>
                  <ng-container *ngFor="let imageUrl of imageUrls; let i = index">
                    <div class="thumbnail-container">
                      <img
                        [src]="imageUrl"
                        class="thumbnail-image"
                        [class.selected]="i === currentImageIndex"
                        (click)="selectThumbnail(i, thumbContainer)"
                      />
                      <ng-container class="image-icon-container" *ngIf="userCanEdit() && form.enabled">
                        <span class="image-icon" (click)="moveImageLeft(i)">‚¨ÖÔ∏è</span>
                        <span class="image-icon" (click)="moveImageRight(i)">‚û°Ô∏è</span>
                        <span class="image-icon" (click)="deleteImage(i)">üóëÔ∏è</span>
                      </ng-container>
                    </div>
                  </ng-container>
                  <div *ngIf="userCanEdit() && form.enabled" class="thumbnail-image">
                    <fa-icon [icon]="faPlus" class="fa-3x add-image-btn" (click)="fileInput.click()">
                    </fa-icon>
                    <input
                      #fileInput
                      type="file"
                      accept="image/*"
                      multiple
                      (change)="onImagesSelected($event)"
                      style="display: none"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div *ngIf="form.enabled" class="button-wrapper">
              <button type="button"
                      (click)="generateImage()"
                      class="ai-button"
                      [disabled]="generatingImage()"
              >
                {{ generatingImage() ? 'Generating Image...' : 'Generate Image with AI' }}
              </button>
              <span *ngIf="generatingImage()" class="spinner"></span>
            </div>
          </div>
          <div class="tag-section">
            <!-- Input to add a new tag -->
            <ng-container *ngIf="userCanEdit() && form.enabled">
              <input
                type="text"
                [(ngModel)]="newTag"
                [ngModelOptions]="{ standalone: true }"
                (keyup.enter)="addNewTag()"
                placeholder="Add a tag"
              />
              <button type="button" (click)="addNewTag()" class="edit-button">Add Tag</button>
            </ng-container>

            <!-- Display tags -->
            <div class="tags-container">
              @for (tag of tagNames.controls; track tag.value; let i = $index) {
                <span class="tag" [title]="tag.value">
                  <span class="tag-text">{{ tag.value }}</span>
                  <fa-icon
                    *ngIf="userCanEdit() && form.enabled"
                    [icon]="faTimes"
                    (click)="removeTag(i)"
                    class="remove-icon"
                  ></fa-icon>
                </span>
              }
            </div>
            <div *ngIf="form.enabled" class="button-wrapper">
              <button type="button"
                      (click)="generateTags()"
                      class="ai-button"
                      [disabled]="generatingTags()"
              >
                {{ generatingTags() ? 'Generating Tags...' : 'Generate Tags with AI' }}
              </button>
              <span *ngIf="generatingTags()" class="spinner"></span>
            </div>
          </div>
        </div>
      </fieldset>
      <fieldset>
        <legend>Pricing</legend>
        <div class="input-wrapper">
          <label>Price:</label>
          <input type="number" formControlName="price"/>
          <div class="validation-error" *ngIf="form.get('price')?.invalid && form.get('price')?.touched">
            Price should be greater than 0.
          </div>
        </div>
        <div class="input-wrapper">
          <label>Discount (%):</label>
          <input type="number" formControlName="discount"/>
          <div class="validation-error" *ngIf="form.get('discount')?.invalid && form.get('discount')?.touched">
            Discount should be non-negative and less than 100.
          </div>
        </div>
      </fieldset>
      @if(userCanEdit()) {
        <div class="button-container">
          <button *ngIf="form.enabled" type="submit" [disabled]="form.invalid" class="submit-button">Submit</button>
          <button *ngIf="form.enabled" type="button" (click)="setupServiceForm()" class="cancel-button">Cancel</button>
        </div>
      }
    </form>
  </div>
  <div class="card">
    <h2>Manage Workers</h2>
    <app-manage-workers [loggedUserPermissions]="service!.permissions"/>
  </div>
  <div class="card">
    <h2>Appointments</h2>
    <app-service-appointments [serviceId]="service!.id"/>
  </div>
}

<app-confirmation-modal *ngIf="deleteServiceModal()"
                        [title]="'Delete Service'"
                        text="delete this service"
                        (confirm)="deleteService()"
                        (close)="deleteServiceModal.set(false)"
></app-confirmation-modal>
