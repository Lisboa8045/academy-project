<div class="availability-management">
  <!-- Header Section -->
  <div class="management-header">
    <h2 class="management-title">Availability Management</h2>
    <app-week-navigation></app-week-navigation>
    <div class="bulk-actions">
      <button (click)="openBulkAddForm()" class="nav-button bulk-add-button">ï¼‹ Add in bulk</button>
      <button (click)="saveAllChanges()" class="nav-button save-all-button"
              [disabled]="(localChanges.length === 0) && (deletedIds.length === 0)">
        ğŸ’¾ Generate
      </button>
    </div>
  </div>

  <!-- Weekly Slots Grid -->
  <div class="weekly-slots">
    <div *ngFor="let day of getWeekDays()" class="day-column" [class.today]="isToday(day)">
      <div class="day-header">
        <div>
          <h4 class="day-title">{{ day | date: 'EEEE' }}</h4>
          <small class="day-date">{{ day | date: 'dd/MM' }}</small>
        </div>
        <button (click)="openAddForm(day)" class="add-slot-button">ï¼‹</button>
      </div>

      <div class="slots-container" *ngIf="getAvailabilityForDay(day).length > 0; else emptyDay">
        <div *ngFor="let avail of getAvailabilityForDay(day)" class="slot-item" [class.pending]="isPending(avail)">
          <div class="slot-info">
            <span class="slot-time">
              {{ avail.startDateTime | date: 'HH:mm' }} - {{ avail.endDateTime | date: 'HH:mm' }}
            </span>
            <span class="slot-status" [class.booked]="isSlotBooked(avail)">
              {{ isSlotBooked(avail) ? 'Booked' : 'Available' }}
            </span>
          </div>
          <div class="slot-actions">
            <button (click)="openEditForm(avail)" class="action-button edit" [disabled]="isSlotBooked(avail)">
              âœï¸
            </button>
            <button (click)="removeAvailability(avail)" class="action-button delete" [disabled]="isSlotBooked(avail)">
              ğŸ—‘ï¸
            </button>
          </div>
        </div>
      </div>

      <ng-template #emptyDay>
        <div class="empty-day">
          <span class="empty-icon">ğŸ“…</span>
          No availability
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Availability Form Modal -->
  <div class="modal-overlay" *ngIf="showFormModal" (click)="closeFormModal()"></div>
  <div class="modal" *ngIf="showFormModal" [class.bulk-modal]="formMode === 'bulk'">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeFormModal()">Ã—</button>
      <h3 class="modal-title">{{ getModalTitle() }}</h3>

      <form [formGroup]="availabilityForm" (ngSubmit)="saveLocalChanges()">
        <div class="time-inputs">
          <div class="time-group">
            <label class="time-label">Start time</label>
            <input type="time" formControlName="startTime" class="time-input" required />
          </div>
          <div class="time-group">
            <label class="time-label">End time</label>
            <input type="time" formControlName="endTime" class="time-input" required />
          </div>
        </div>

        <div class="recurrence-section">
          <label class="recurrence-label">Repeat:</label>
          <div class="recurrence-options">
            <button *ngFor="let option of recurrenceOptions"
                    type="button"
                    class="recurrence-option"
                    [class.active]="availabilityForm.get('applyType')?.value === option.value"
                    (click)="availabilityForm.get('applyType')?.setValue(option.value)">
              {{ option.label }}
            </button>
          </div>
        </div>

        <div *ngIf="availabilityForm.get('applyType')?.value === 'some-months'" class="month-selection">
          <h4 class="selection-title">Select months:</h4>
          <div class="month-grid">
            <button *ngFor="let month of monthsList"
                    type="button"
                    class="recurrence-option"
                    [class.selected]="isMonthSelected(month.value)"
                    (click)="toggleMonthSelection(month.value)">
              {{ month.label }}
            </button>
          </div>
        </div>

        <div *ngIf="formMode === 'bulk' || availabilityForm.get('applyType')?.value !== 'one-day'" class="days-selection">
          <h4 class="selection-title">Select week days:</h4>
          <div class="days-grid">
            <button *ngFor="let day of daysOfWeek"
                    type="button"
                    class="recurrence-option"
                    [class.selected]="isDaySelected(day.value)"
                    (click)="toggleDaySelection(day.value)">
              {{ day.label }}
            </button>
          </div>
        </div>

        <div class="modal-actions">
          <button type="submit" class="nav-button save-button" [disabled]="!availabilityForm.valid">
            {{ formMode === 'edit' ? 'Update' : 'Save' }}
          </button>
          <button type="button" (click)="closeFormModal()" class="nav-button cancel-button">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="confirmation-modal" *ngIf="showDeleteConfirmation">
    <div class="confirmation-content">
      <h3 class="confirmation-title">Confirm deletion</h3>
      <p class="confirmation-message">Are you sure you want to delete this availability?</p>
      <div class="confirmation-actions">
        <button (click)="confirmDelete()" class="nav-button confirm-button">Yes, delete</button>
        <button (click)="cancelDelete()" class="nav-button">Cancel</button>
      </div>
    </div>
  </div>
</div>
