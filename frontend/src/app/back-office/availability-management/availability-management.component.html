<div class="availability-management">
  <!-- Header Section -->
  <div class="management-header">
    <h2 class="management-title">
      {{ isSettingDefaults ? 'Set Default Weekly Availability' : 'Availability Management' }}
    </h2>
    <app-week-navigation *ngIf="!isSettingDefaults"></app-week-navigation>
    <div class="bulk-actions">
      <button *ngIf="!isSettingDefaults" (click)="openBulkAddForm()" class="nav-button bulk-add-button">＋ Add in bulk</button>
      <button (click)="saveAllChanges()" class="nav-button save-all-button"
              [disabled]="(localChanges.length === 0) && (deletedIds.length === 0)">
        {{ isSettingDefaults ? 'Save Defaults' : 'Save Changes' }}
      </button>
    </div>
  </div>

  <!-- Help text for default setup -->
  <div *ngIf="isSettingDefaults" class="setup-instructions">
    <p>Please set your default weekly availability. These will be your regular working hours.</p>
    <p>You can add exceptions for specific dates later.</p>
  </div>

  <!-- Weekly Slots Grid -->
  <div class="weekly-slots">
    <div *ngFor="let day of getWeekDays()" class="day-column" [class.today]="isToday(day)">
      <div class="day-header">
        <div>
          <h4 class="day-title">{{ day | date: 'EEEE' }}</h4>
          <small class="day-date">{{ day | date: 'dd/MM' }}</small>
        </div>
        <button (click)="openAddForm(day)" class="add-slot-button">＋</button>
      </div>

      <div class="slots-container" *ngIf="getAvailabilityForDay(day).length > 0; else emptyDay">
        <div *ngFor="let avail of getAvailabilityForDay(day); trackBy: trackByAvailability"
             class="slot-item"
             [class.pending]="isPending(avail)"
             [class.default-slot]="!avail.isException"
             [class.exception-slot]="avail.isException">
          <div class="slot-info">
      <span class="slot-time">
        {{ avail.startDateTime | date: 'HH:mm' }} - {{ avail.endDateTime | date: 'HH:mm' }}
      </span>
            <span *ngIf="avail.isException" class="exception-badge">Exception</span>
            <span *ngIf="!avail.isException" class="default-badge">Default</span>
          </div>
          <div class="slot-actions">
            <button (click)="openEditForm(avail)" class="action-button edit">
              ✏️
            </button>
            <button *ngIf="avail.isException" (click)="removeAvailability(avail)" class="action-button delete">
              🗑️
            </button>
          </div>
        </div>
      </div>

      <ng-template #emptyDay>
        <div class="empty-day">
          <span class="empty-icon">📅</span>
          No availability set
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Availability Form Modal -->
  <div class="modal" *ngIf="showFormModal">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeFormModal()">×</button>
      <h3 class="modal-title">{{ getModalTitle() }}</h3>

      <form [formGroup]="availabilityForm" (ngSubmit)="saveLocalChanges()">
        <div class="time-inputs">
          <div class="time-group">
            <label class="time-label">Morning</label>
            <div class="interval-row">
              <input type="time" formControlName="startTime1" class="time-input" required />
              <span>to</span>
              <input type="time" formControlName="endTime1" class="time-input" required />
            </div>
          </div>
          <div class="time-group">
            <label class="time-label">Afternoon</label>
            <div class="interval-row">
              <input type="time" formControlName="startTime2" class="time-input" />
              <span>to</span>
              <input type="time" formControlName="endTime2" class="time-input" />
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="submit" class="nav-button save-button" [disabled]="!availabilityForm.valid">
            {{ formMode === 'edit' ? 'Update' : 'Save' }}
          </button>
          <button type="button" (click)="closeFormModal()" class="nav-button cancel-button">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="confirmation-modal" *ngIf="showDeleteConfirmation">
    <div class="confirmation-content">
      <h3 class="confirmation-title">Confirm deletion</h3>
      <p class="confirmation-message">Are you sure you want to delete this availability?</p>
      <div class="confirmation-actions">
        <button (click)="confirmDelete()" class="nav-button confirm-button">Yes, delete</button>
        <button (click)="cancelDelete()" class="nav-button">Cancel</button>
      </div>
    </div>
  </div>
</div>
